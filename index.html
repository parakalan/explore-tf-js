<html>
<head>
    <title>Train a text classifier</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
<script src="js/train.js"></script>

<script type="text/javascript">
    let total = 0;
    var trainer = new Worker('js/train.js');
    messageMap = {
        "increment_embeddings": (i) =>  {
            document.getElementById("embeddings").setAttribute('value', i);
            document.getElementById("embeddings_percent").innerHtml = i.toString() + ' / '+ total.toString();
        },
        "increment_epoch": (i) => {
            document.getElementById("training").setAttribute("value", i+1);
        }
    }
    async function process() {
        var fileUpload = document.getElementById("file")
        var reader = new FileReader();
        reader.onload = async function (e) {
                var workbook = XLSX.read(e.target.result, {
                type: 'binary'
            });
            var excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[ workbook.SheetNames[0]]);
            excelRows = filter(excelRows);
            console.log(excelRows.length)
            total = excelRows.length;
            trainer.postMessage(excelRows)
        };
        reader.readAsBinaryString(fileUpload.files[0]);
    }

    function filter(data) {
        let copyData = [];
        for(var i=0; i < data.length; i++) {
            if(data[i].Message != undefined) {
                copyData.push(data[i]);
            }
        }
        return copyData;
    }

    trainer.onmessage = function(e) {
        message = e.data[0];
        args = e.data[1]
        messageMap[message](args)
        console.log('Message received from worker');
    }
</script>
<body>
    <input type="file" name="file" id="file">
    <button id="train" onclick="process()">Train</button>
    <div></div><br><br>
    <div>
        <label for="embeddings">Embeddings</label>&nbsp;&nbsp;
        <progress id="embeddings" value="0" max="5000" style="height:24px;width:50%;border-radius:0px"></progress>
        <span id="embeddings_percent"></span>
    </div>
    <br><br>
    <div>
        <label for="training">Training</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <progress id="training" value="0" max="100" style="height:24px;width:50%;border-radius:0px"></progress>
        <span id="training_percent"></span>
    </div>
</body>

